---
title: "Clinical Volume"
format: html
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gt)
library(glue)
library(clock)
library(googledrive)
library(googlesheets4)
```

As part of clinical training (internal medicine residency, cardiovascular disease fellowship, clinical cardiac electrophysiology fellowship), clinical and procedural volume are important in the development of skills/competence. The following is a summary of volume received during training thus far: 

```{r}
#| label: volume
#| echo: false

consults <-
	googledrive::drive_get('clinical_log') |>
	googlesheets4::read_sheet('consults') |>
	janitor::clean_names()

procedures <-
	googledrive::drive_get('clinical_log') |>
	googlesheets4::read_sheet('procedures') |>
	janitor::clean_names() |>
	filter(!is.na(procedure))
```


```{r}
#| label: download
#| echo: false
#source("R/make-anonymous.R", local = knitr::knit_global())
log <- readr::read_csv("anonymous.csv") 

start <- min(log$date, na.rm = TRUE)
stop <- max(log$date, na.rm = TRUE)

# Columns = site | mrn | date | dx1:3 | procedure | location | modifier | notes | special
# Can be broken down into groups based on procedures versus clinical 
procedures <- subset(log, !is.na(procedure)) |>
	rename(type = procedure)
clinical <- subset(log, is.na(procedure))
```

Below is a summary of procedures that have been performed during training.

```{r}
#| label: procedures
#| echo: false

# Master list
types <- list(
	cath = c('COR', 'RHC', 'LHC', 'PCI', 'pericardiocentesis', 'MCS'),
	vascular = c('CVL', 'AL', 'PIV', 'closure'),
	ep = c('DCCV', 'CIED', 'EPS', 'TVP', 'ACLS', 'defibrillation'),
	imaging = c('TTE', 'TEE', 'stress', 'MRI', 'CT', 'US')
)

# Create categories
cats <- character()
for (i in seq_along(types)) {
	cats <- append(cats, rep(names(types[i]), length(types[[i]])))
}

# Make table
tbl <- tibble(
	category = cats,
	procedure = unlist(types)
)

# Identifiers of procedure modifiers with categorizations
log <-
	procedures |>
	select(procedure, type, modifier) 

# Master table
proc <- full_join(tbl, log, by = 'procedure')

# Some procedures need specific modifiers, located in the location name
	# Caths -> needs modifier for site
	# TTE -> needs modifier for bedside or not
	# TEE -> needs modifier for if bedside or not
	# EPS -> needs modifier for type
	# DCCV -> modifier for joules, not really needed
	# TVP -> modifier
	# AL/CVL -> lines with locations in modifier

```


```{r}
#| label: counts
#| eval: false


proc |>
	count(procedure) 

proc |>
	count(category)
```	

```{r}
#| label: cocats
#| echo: false
# Required COCATS procedures for fellowship
	# TTE performed (150)
	# TTE interpreted (300)
	# Stress echo (100)
	# TEE performed (50, 100)
	# Nuclear (300)
	# Nuclear injections (35)
	# Cardiac CT interpreted (250)
	# Cardiac CT performed (65)
	# CMR performed (50)
	# CMR interpreted (150)
	# Caths performed (300)
	# TVP performed (5)
	# PPM performed (20, 40)
	# CIED interrogated (100)
	# CIED remote interrogated (25)
	# Cardioversion (20)
	# PCI
	# Pericardiocentesis
	# IABP
	# Impella
	# Other

cocats <- 
	proc |>
	filter(
		procedure == "TTE" & type == "bedside" |
			procedure == "TTE" & is.na(type) |
			procedure == "stress" & modifier == "echo" |
			procedure == "TEE" & type == "bedside" |
			procedure == "TEE" & is.na(type) |
			procedure == "stress" & (modifier == "technetium" | modifier == "thallium") |
			procedure == "CT" |
			procedure == "CMR" & type == "bedside" |
			procedure == "CMR" & is.na(type) |
			(procedure == "RHC" | procedure == "LHC" | procedure == "COR") |
			procedure == "TVP" |
			procedure == "CIED" & type != "interrogation" |
			procedure == "CIED" & type == "interrogation" |
			procedure == "DCCV" |
			procedure == "PCI" |
			procedure == "pericardiocentesis" |
			procedure == "MCS" 
	) |>
	mutate(modifier = case_when(
		procedure == "COR" ~ NA_character_,
		procedure == "RHC" ~ NA_character_,
		procedure == "LHC" ~ NA_character_,
		procedure == "PCI" ~ NA_character_,
		procedure == "DCCV" ~ NA_character_,
		procedure == "MCS" ~ NA_character_,
		procedure == "CIED" & type == "interrogation" ~ NA_character_,
		procedure == "CIED" & !type == "interrogation" ~ NA_character_,
		procedure == "TTE" ~ NA_character_,
		procedure == "TEE" ~ NA_character_,
		procedure == "stress" & modifier == "technetium" ~ "nuclear",
		procedure == "stress" & modifier == "thallium" ~ "nuclear",
		TRUE ~ modifier
	)) |>
	mutate(type = case_when(
		procedure == "COR" ~ NA_character_,
		procedure == "RHC" ~ NA_character_,
		procedure == "LHC" ~ NA_character_,
		procedure == "PCI" ~ NA_character_,
		procedure == "pericardiocentesis" ~ NA_character_,
		procedure == "DCCV" ~ NA_character_,
		procedure == "MCS" ~ NA_character_,
		procedure == "CIED" & !type == "interrogation" ~ NA_character_,
		procedure == "TVP" ~ NA_character_,
		procedure == "stress" & modifier == "echo" ~ NA_character_,
		procedure == "stress" & modifier == "nuclear" ~ NA_character_,
		TRUE ~ type
	)) |>
	mutate(procedure = case_when(
		procedure %in% c("COR", "RHC", "LHC") ~ "CATH",
		TRUE ~ procedure
	)) |>
	count(procedure, type, modifier) 

gt(cocats)
```

